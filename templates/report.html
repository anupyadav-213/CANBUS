<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Report - CAN Bus Security Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <style>
        body {
            background: #f5f7fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            margin-bottom: 30px;
        }
        
        .stat-box {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }
        
        .stat-box h5 {
            color: #667eea;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: #333;
        }
        
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            position: relative;
            height: 400px;
        }
        
        .alert-item {
            background: white;
            border-left: 5px solid;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        
        .alert-critical {
            border-left-color: #e74c3c;
        }
        
        .alert-high {
            border-left-color: #e67e22;
        }
        
        .alert-medium {
            border-left-color: #f39c12;
        }
        
        .alert-low {
            border-left-color: #27ae60;
        }
        
        .btn-back {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-back:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .severity-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .badge-critical {
            background: #e74c3c;
            color: white;
        }
        
        .badge-high {
            background: #e67e22;
            color: white;
        }
        
        .badge-medium {
            background: #f39c12;
            color: white;
        }
        
        .badge-low {
            background: #27ae60;
            color: white;
        }
        
        .container-lg {
            max-width: 1200px;
        }
        
        h2 {
            color: #333;
            font-weight: 800;
            margin-bottom: 30px;
        }
        
        .table-responsive {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        table {
            margin: 0;
        }
        
        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container-lg">
            <button class="btn-back mb-3" onclick="goToDashboard()">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </button>
            <h1 style="margin: 0;">Analysis Report</h1>
            <p style="margin-top: 10px; opacity: 0.9;">CAN Bus Security Analysis Results</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container-lg">
        <!-- Report Summary -->
        <div id="reportSummary" style="background: white; padding: 30px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
            <h4 style="color: #667eea; margin-bottom: 20px;">Report Summary</h4>
            <div class="row">
                <div class="col-md-3">
                    <div style="margin-bottom: 15px;">
                        <label style="color: #666; font-size: 0.9rem;">Analysis ID:</label>
                        <p style="margin: 0; font-weight: 600;" id="analysisId">Loading...</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div style="margin-bottom: 15px;">
                        <label style="color: #666; font-size: 0.9rem;">Filename:</label>
                        <p style="margin: 0; font-weight: 600;" id="filename">Loading...</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div style="margin-bottom: 15px;">
                        <label style="color: #666; font-size: 0.9rem;">Processing Time:</label>
                        <p style="margin: 0; font-weight: 600;" id="processingTime">Loading...</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div style="margin-bottom: 15px;">
                        <label style="color: #666; font-size: 0.9rem;">Accuracy:</label>
                        <p style="margin: 0; font-weight: 600;" id="accuracy">Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <h2 style="margin-top: 40px;">Statistics</h2>
        <div class="row">
            <div class="col-md-3">
                <div class="stat-box">
                    <h5>Total Messages</h5>
                    <div class="stat-number" id="totalMessages">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box" style="border-left-color: #e74c3c;">
                    <h5 style="color: #e74c3c;">Total Alerts</h5>
                    <div class="stat-number" id="totalAlerts">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box" style="border-left-color: #27ae60;">
                    <h5 style="color: #27ae60;">Average Accuracy</h5>
                    <div class="stat-number" id="avgAccuracy">92%</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box" style="border-left-color: #f39c12;">
                    <h5 style="color: #f39c12;">Processing Speed</h5>
                    <div class="stat-number" style="font-size: 1.5rem;"><10ms</div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <h2 style="margin-top: 40px;">Alert Distribution</h2>
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <canvas id="alertsByTypeChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <canvas id="alertsBySeverityChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Alerts Table -->
        <h2 style="margin-top: 40px;">Detected Alerts</h2>
        <div class="table-responsive">
            <table class="table table-hover" id="alertsTable">
                <thead>
                    <tr>
                        <th>Time (s)</th>
                        <th>Type</th>
                        <th>Severity</th>
                        <th>CAN ID</th>
                        <th>Confidence</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody id="alertsTableBody">
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                            <i class="fas fa-spinner fa-spin"></i> Loading alerts...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Action Buttons -->
        <div style="margin: 40px 0; text-align: center;">
            <button class="btn-back" onclick="goToDashboard()" style="margin-right: 10px;">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </button>
            <button class="btn-back" onclick="exportReport()" style="background: #27ae60;">
                <i class="fas fa-download"></i> Export Report
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let analysisId = null;
        let analysisData = null;

        // Get analysis ID from URL
        const urlParams = new URLSearchParams(window.location.pathname.split('/').pop());
        analysisId = window.location.pathname.split('/').pop();

        // Load analysis data
        async function loadAnalysis() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`/api/analysis/${analysisId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    analysisData = data;
                    displayReport(data);
                } else if (response.status === 401) {
                    alert('Session expired. Redirecting to login...');
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Error loading analysis:', error);
                alert('Error loading report');
            }
        }

        // Display report
        function displayReport(data) {
            const analysis = data.analysis;
            const alerts = data.alerts;

            // Summary
            document.getElementById('analysisId').textContent = analysis.id;
            document.getElementById('filename').textContent = analysis.filename;
            document.getElementById('processingTime').textContent = analysis.processing_time.toFixed(3) + 's';
            document.getElementById('accuracy').textContent = (analysis.accuracy * 100).toFixed(0) + '%';

            // Statistics
            document.getElementById('totalMessages').textContent = analysis.total_messages.toLocaleString();
            document.getElementById('totalAlerts').textContent = analysis.total_alerts;
            document.getElementById('avgAccuracy').textContent = (analysis.accuracy * 100).toFixed(0) + '%';

            // Group alerts
            const byType = {};
            const bySeverity = {};

            alerts.forEach(alert => {
                if (!byType[alert.alert_type]) byType[alert.alert_type] = 0;
                byType[alert.alert_type]++;

                if (!bySeverity[alert.severity]) bySeverity[alert.severity] = 0;
                bySeverity[alert.severity]++;
            });

            // Charts
            const colors = ['#667eea', '#764ba2', '#e74c3c', '#f39c12', '#2ecc71'];
            const severityColors = {
                'CRITICAL': '#e74c3c',
                'HIGH': '#e67e22',
                'MEDIUM': '#f39c12',
                'LOW': '#27ae60'
            };

            // Alert by Type Chart
            const typeCtx = document.getElementById('alertsByTypeChart').getContext('2d');
            new Chart(typeCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(byType),
                    datasets: [{
                        data: Object.values(byType),
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        title: { display: true, text: 'Alerts by Type' }
                    }
                }
            });

            // Alert by Severity Chart
            const severityCtx = document.getElementById('alertsBySeverityChart').getContext('2d');
            const severityLabels = Object.keys(bySeverity);
            const severityValues = Object.values(bySeverity);
            const severityBgColors = severityLabels.map(s => severityColors[s] || '#999');

            new Chart(severityCtx, {
                type: 'bar',
                data: {
                    labels: severityLabels,
                    datasets: [{
                        label: 'Alerts',
                        data: severityValues,
                        backgroundColor: severityBgColors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Alerts by Severity' }
                    }
                }
            });

            // Alerts Table
            const tbody = document.getElementById('alertsTableBody');
            tbody.innerHTML = '';

            if (alerts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #999;">No alerts detected</td></tr>';
            } else {
                alerts.forEach(alert => {
                    const severityClass = 'badge-' + alert.severity.toLowerCase();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${alert.timestamp ? alert.timestamp.toFixed(2) : 'N/A'}</td>
                        <td>${alert.alert_type}</td>
                        <td><span class="severity-badge ${severityClass}">${alert.severity}</span></td>
                        <td>${alert.can_id}</td>
                        <td>${(alert.confidence * 100).toFixed(0)}%</td>
                        <td>${alert.description}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        // Go to Dashboard
        function goToDashboard() {
            window.location.href = '/dashboard';
        }

        // Export Report
        function exportReport() {
            const reportData = {
                analysis: analysisData.analysis,
                alerts: analysisData.alerts,
                exportedAt: new Date().toISOString()
            };

            const dataStr = JSON.stringify(reportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `analysis_${analysisData.analysis.id}.json`;
            link.click();
        }

        // Load on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadAnalysis();
        });
    </script>
</body>
</html>
